# VoiceSphinx Client

Клиентская часть системы офлайн-распознавания речи VoiceSphinx.

## Возможности

- Запись речи с микрофона
- Два режима работы:
  - Режим по горячей клавише (Win + Alt + Z)
  - Автоматический режим с VAD
- Отправка аудио на сервер
- Вставка распознанного текста в активное окно
- Кроссплатформенность (Windows/Linux)
- Настраиваемые параметры через config.json

## Требования

- Python 3.10+
- Микрофон
- Доступ к серверу VoiceSphinx

## Установка

1. Клонируйте репозиторий:
```bash
git clone https://github.com/yourusername/voice-sphinx.git
cd voice-sphinx/voice-sphinx-client
```

2. Создайте виртуальное окружение и активируйте его:
```bash
python -m venv venv
# Windows
venv\Scripts\activate
# Linux/macOS
source venv/bin/activate
```

3. Установите зависимости:
```bash
pip install -r requirements.txt
```

> **ВАЖНО**: Перед каждым запуском клиента необходимо активировать виртуальное окружение:
> ```bash
> # Windows
> venv\Scripts\activate
> # Linux/macOS
> source venv/bin/activate
> ```
> 
> Если вы видите ошибки импорта модулей или отсутствие зависимостей, скорее всего, вы забыли активировать виртуальное окружение.

## Конфигурация

Настройки клиента находятся в файле `config.json`:

```json
{
  "server": {
    "url": "http://localhost:8000/transcribe"
  },
  "audio": {
    "sample_rate": 16000,
    "channels": 1,
    "device": null,
    "vad_mode": 3,
    "silence_threshold": 1.0,
    "max_recording_time": 30.0
  },
  "hotkeys": {
    "record": ["alt", "win", "z"],
    "cancel": ["escape"]
  },
  "mode": "hotkey",
  "log_level": "info"
}
```

### Параметры конфигурации

- `server.url`: URL сервера для отправки аудио
- `audio.sample_rate`: Частота дискретизации аудио
- `audio.channels`: Количество каналов аудио
- `audio.device`: ID устройства для записи (null = по умолчанию)
- `audio.vad_mode`: Режим VAD (1-3)
- `audio.silence_threshold`: Порог тишины в секундах
- `audio.max_recording_time`: Максимальное время записи в секундах
- `hotkeys.record`: Горячая клавиша для записи
- `hotkeys.cancel`: Горячая клавиша для отмены
- `mode`: Режим работы ("hotkey" или "auto")
- `log_level`: Уровень логирования

## Настройка микрофона

В системе с несколькими микрофонами важно правильно настроить устройство ввода для качественной записи речи.

### Варианты настройки микрофона:

1. **Использование микрофона по умолчанию**
   
   В файле `config.json` установите:
   ```json
   "device": null
   ```

2. **Использование конкретного микрофона по ID**
   
   В файле `config.json` установите:
   ```json
   "device": 1  // где 1 - это ID нужного микрофона
   ```

3. **Использование микрофона по имени**
   
   В файле `config.json` установите:
   ```json
   "device": "Микрофон (HD Pro Webcam)"  // частичное имя устройства
   ```

> **Примеры настройки микрофона:**
> - `"device": null` - использовать микрофон по умолчанию
> - `"device": 0` - использовать микрофон с индексом 0
> - `"device": "Микрофон (HD Pro Webcam)"` - использовать микрофон, содержащий это название

### Утилиты для управления микрофонами

```
python main.py --list-mics        # Показать список микрофонов
python main.py --test-mic         # Тестировать выбранный микрофон
python main.py --test-mic --force # Тестировать выбранный микрофон, игнорируя низкий уровень сигнала
python main.py --test-mic-id 1    # Тестировать микрофон с ID 1
python main.py --set-mic 1        # Установить микрофон с ID 1
python main.py --set-mic "Webcam" # Установить микрофон по имени
python main.py --set-mic default  # Использовать микрофон по умолчанию
```

### Проверка записи с микрофона

При возникновении проблем с записью звука:

1. Убедитесь, что микрофон подключен и работает в операционной системе
2. Проверьте, что микрофон не отключен в настройках системы
3. Используйте команду `--test-mic` для проверки уровня звука и записи
4. Если уровень звука слишком низкий, проверьте настройки громкости микрофона
5. Попробуйте другой микрофон, если доступно несколько устройств

### Диагностика проблем

Если при тестировании микрофона возникают проблемы:

1. **Красный индикатор** (уровень < 0.05) - микрофон не работает или отключен
2. **Желтый индикатор** (уровень < 0.2) - сигнал слабый, говорите громче или приблизьтесь к микрофону
3. **Зеленый индикатор** - нормальный уровень звука

При отсутствии индикации активности:
- Проверьте, не выбран ли неправильный микрофон
- Проверьте, не отключен ли микрофон в настройках операционной системы
- Попробуйте перезапустить программу или компьютер

### Решение распространенных проблем

#### Ошибка "Error while processing frame"

Если возникает ошибка "Error while processing frame" или другие ошибки в обработке аудио-фреймов:

1. Используйте опцию `--force` при тестировании микрофона для игнорирования низкого уровня сигнала:
   ```
   python main.py --test-mic --force
   ```

2. Проверьте формат аудио в конфигурации:
   - Частота дискретизации должна быть 16000 Hz
   - Количество каналов должно быть 1 (моно)

3. Возможно, проблема связана с несовместимостью размера аудио-фрейма и VAD (Voice Activity Detection). 
   Проверьте следующие настройки в конфигурации:
   ```json
   "audio": {
     "sample_rate": 16000,
     "channels": 1,
     "vad_mode": 3,
     "silence_threshold": 1.0
   }
   ```

4. Если проблема сохраняется, попробуйте использовать другой микрофон:
   ```
   python main.py --list-mics  # Узнать список микрофонов
   python main.py --set-mic 1  # Установить другой микрофон
   ```

#### Микрофон не определяется

Если микрофон не определяется системой:

1. Проверьте подключение микрофона
2. Убедитесь, что драйверы устройства установлены правильно
3. Проверьте разрешения приложений для использования микрофона в настройках системы
4. Временно отключите другие аудиоустройства, которые могут конфликтовать
5. Перезагрузите компьютер для применения изменений драйверов

#### Совместимость с операционными системами

- **Windows**: Используйте стандартные настройки аудиоустройств для выбора микрофона по умолчанию
- **Linux**: Проверьте настройки PulseAudio или ALSA для правильной конфигурации микрофона
- **macOS**: Убедитесь, что приложение имеет разрешение на доступ к микрофону в настройках безопасности

## Использование

1. Запустите клиент:
```bash
python src/main.py
```

2. В режиме по горячей клавише:
   - Нажмите Win + Alt + Z для начала записи
   - Говорите
   - Отпустите клавиши для остановки записи
   - Текст будет автоматически вставлен в активное окно

3. В автоматическом режиме:
   - Клиент автоматически определяет речь
   - При обнаружении тишины запись останавливается
   - Текст автоматически вставляется в активное окно

## Логирование

Логи выводятся в консоль с указанием времени, уровня, модуля и сообщения.

## Разработка

### Структура проекта

```
voice-sphinx-client/
├── src/
│   ├── __init__.py
│   ├── main.py              # Точка входа
│   ├── config.py            # Конфигурация
│   ├── audio/               # Модули для работы с аудио
│   │   ├── __init__.py
│   │   └── recorder.py
│   ├── network/             # Сетевое взаимодействие
│   │   ├── __init__.py
│   │   └── api_client.py
│   ├── input/               # Вставка текста
│   │   ├── __init__.py
│   │   └── text_inserter.py
│   ├── hotkeys/             # Обработка горячих клавиш
│   │   ├── __init__.py
│   │   └── keyboard_listener.py
│   └── utils/               # Вспомогательные функции
│       ├── __init__.py
│       └── platform_utils.py
├── requirements.txt
├── config.json
└── README.md
```

## Лицензия

MIT 

### Проверка виртуального окружения и микрофона

Если у вас возникают проблемы с запуском клиента или тестированием микрофона, следуйте этим шагам для диагностики:

1. **Убедитесь, что виртуальное окружение активировано**:
   ```bash
   # Windows - проверьте, что в начале командной строки есть (venv)
   # Если нет, активируйте окружение:
   venv\Scripts\activate
   
   # Linux/macOS
   source venv/bin/activate
   ```

2. **Проверьте установленные зависимости**:
   ```bash
   pip list
   ```
   Убедитесь, что в списке есть необходимые пакеты (sounddevice, numpy, webrtcvad и другие).

3. **Проверьте работу микрофона напрямую через Python**:
   ```python
   # Сохраните в файл mic_check.py и запустите
   import sounddevice as sd
   import numpy as np
   import time
   
   # Вывод списка устройств
   print("Доступные устройства:")
   devices = sd.query_devices()
   for i, dev in enumerate(devices):
       print(f"{i}: {dev['name']}")
   
   # Выбор устройства по умолчанию или указанного
   device_id = None  # Можно заменить на ID вашего микрофона
   
   # Параметры записи
   duration = 3  # секунды
   sample_rate = 16000
   channels = 1
   
   print(f"Запись с микрофона {duration} секунд...")
   
   # Записываем аудио
   recording = sd.rec(
       int(duration * sample_rate),
       samplerate=sample_rate,
       channels=channels,
       device=device_id,
       dtype='float32'
   )
   
   # Ждем окончания записи
   sd.wait()
   
   # Проверяем уровень сигнала
   rms = np.sqrt(np.mean(recording**2))
   peak = np.max(np.abs(recording))
   
   print(f"RMS уровень: {rms:.6f}")
   print(f"Пиковый уровень: {peak:.6f}")
   
   if rms > 0.0001:
       print("Микрофон работает!")
   else:
       print("Очень низкий уровень сигнала. Проверьте настройки микрофона.")
   ```

4. **Если у вас Windows, проверьте настройки приватности микрофона**:
   - Откройте Параметры Windows → Конфиденциальность → Микрофон
   - Убедитесь, что доступ к микрофону разрешен для приложений

5. **Проверьте, что микрофон установлен как устройство по умолчанию**:
   - Щелкните правой кнопкой мыши на значке звука в панели задач
   - Выберите "Звук" → вкладка "Запись"
   - Убедитесь, что нужный микрофон установлен по умолчанию 

### Проверка работы микрофона

Для проверки работы микрофона и поиска проблем используйте простую отдельную утилиту `mic_check.py`:

```bash
# Показать список доступных микрофонов
python mic_check.py --list

# Тестировать микрофон по умолчанию
python mic_check.py

# Тестировать конкретный микрофон по ID
python mic_check.py --device 1

# Изменить параметры записи
python mic_check.py --sample-rate 44100 --channels 2 --duration 5
```

Эта утилита поможет:
1. Убедиться, что Python видит ваш микрофон
2. Проверить уровень сигнала с микрофона
3. Выявить проблемы с настройками звука

Преимущества этой утилиты:
- Максимально простой код без зависимостей от основного приложения
- Минимальный набор необходимых библиотек
- Чёткая диагностика проблем с микрофоном

> **Важно**: Если `mic_check.py` работает корректно, но основное приложение выдаёт ошибки, скорее всего проблема в виртуальном окружении или конфигурации основного приложения. 